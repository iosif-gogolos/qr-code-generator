<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Modern QR-Code Generator</title>
  <!-- Bootstrap 5 CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <!-- qrcodejs Bibliothek -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    /* Farbpalette & Grundlayout */
    body {
      background-color: #F2EFE7;
    }
    .navbar {
      background-color: #2973B2;
    }
    .navbar-toggler {
      border-color: #9ACBD0;
    }
    .dropdown-menu {
      background-color: #48A6A7;
    }
    .qr-card {
      max-width: 600px;
      margin: 3rem auto;
      padding: 2rem;
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      background-color: #ffffff;
    }
    /* Dropdown als Hover-Menü */
    .dropdown:hover .dropdown-menu {
      display: block;
    }
    /* DIN A4 Canvas (wird als temporäres Element genutzt) */
    #a4Canvas {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Navbar mit Hamburger Menü -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">QR-Code Generator</a>
      <div class="dropdown">
        <button class="navbar-toggler" type="button">
          <span class="navbar-toggler-icon"></span>
        </button>
        <ul class="dropdown-menu">
          <li>
            <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#historyModal">
              Verlauf
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  
  <!-- Hauptbereich mit Eingabefeldern und QR-Vorschau -->
  <div class="container">
    <div class="qr-card mt-4">
      <div class="mb-3">
        <label for="qrName" class="form-label">QR-Code Name</label>
        <input type="text" id="qrName" class="form-control" placeholder="Name des QR Codes">
      </div>
      <div class="mb-3">
        <label for="urlInput" class="form-label">URL</label>
        <input type="text" id="urlInput" class="form-control" placeholder="https://example.com">
      </div>
      <button class="btn btn-primary mb-3" onclick="generateQRCode()">QR-Code generieren</button>
      <div id="qrPreview" class="text-center"></div>
    </div>
  </div>

  <!-- Modal: Verlauf der generierten QR Codes -->
  <div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header" style="background-color: #2973B2; color: white;">
          <h5 class="modal-title" id="historyModalLabel">Verlauf der generierten QR Codes</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
        </div>
        <div class="modal-body">
          <div id="historyList" class="list-group">
            <!-- Dynamische Liste der Einträge -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Temporäres DIN A4 Canvas (wird für den PNG-Export genutzt) -->
  <canvas id="a4Canvas" width="792" height="1123"></canvas>

  <!-- JavaScript -->
  <script>
    // Falls noch kein Verlauf in localStorage vorhanden ist, initialisieren
    if (!localStorage.getItem('qrHistory')) {
      localStorage.setItem('qrHistory', JSON.stringify([]));
    }
    
    /**
     * Erzeugt den QR-Code in der Vorschau und speichert den Eintrag (Name & URL) im localStorage.
     */
    function generateQRCode() {
      var url = document.getElementById("urlInput").value.trim();
      var name = document.getElementById("qrName").value.trim();
      
      if (!url) {
        alert("Bitte geben Sie eine gültige URL ein.");
        return;
      }
      if (!name) {
        alert("Bitte geben Sie einen Namen für den QR-Code ein.");
        return;
      }
      
      // Vorschau-Container leeren
      var preview = document.getElementById("qrPreview");
      preview.innerHTML = "";
      
      // QR-Code in der Vorschau generieren (Größe 200x200)
      new QRCode(preview, {
        text: url,
        width: 200,
        height: 200,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
      });
      
      // In den Verlauf speichern
      var history = JSON.parse(localStorage.getItem('qrHistory'));
      history.push({ name: name, url: url, date: new Date().toISOString() });
      localStorage.setItem('qrHistory', JSON.stringify(history));
      
      // Aktualisiere die Liste im Modal (falls geöffnet)
      updateHistoryList();
    }
    
    /**
     * Aktualisiert die Liste im "Verlauf"-Modal anhand der in localStorage gespeicherten Einträge.
     */
    function updateHistoryList() {
      var history = JSON.parse(localStorage.getItem('qrHistory'));
      var historyList = document.getElementById("historyList");
      historyList.innerHTML = "";
      
      if(history.length === 0) {
        historyList.innerHTML = "<p class='text-center'>Kein Verlauf vorhanden.</p>";
        return;
      }
      
      // Neueste Einträge zuerst – hier über eine Kopie des Arrays
      var reversedHistory = history.slice().reverse();
      reversedHistory.forEach(function(item) {
        // Einfaches Escapen von Anführungszeichen für den Inline-Handler
        var safeName = item.name.replace(/"/g, '&quot;');
        var safeUrl  = item.url.replace(/"/g, '&quot;');
        var listItem = document.createElement("div");
        listItem.className = "list-group-item d-flex justify-content-between align-items-center";
        listItem.innerHTML = "<div><strong>" + safeName + "</strong><br><small>" + safeUrl + "</small></div>" +
                             "<button class='btn btn-sm btn-outline-primary' onclick='downloadPNG(\"" + safeName + "\", \"" + safeUrl + "\")'>Download PNG</button>";
        historyList.appendChild(listItem);
      });
    }
    
    // Aktualisiere die Liste, wenn das Modal geöffnet wird
    var historyModal = document.getElementById('historyModal');
    historyModal.addEventListener('show.bs.modal', updateHistoryList);
    
    /**
     * Generiert ein DIN-A4 großes PNG (792×1123px) mit Titel und QR-Code und löst den Download aus.
     * Es wird ein temporärer Container genutzt, um den QR-Code in hoher Auflösung (hier 400×400px) zu erzeugen.
     */
    function downloadPNG(name, url) {
      // Temporären Container anlegen (unsichtbar im DOM)
      var tempDiv = document.createElement("div");
      tempDiv.style.position = "absolute";
      tempDiv.style.left = "-9999px";
      document.body.appendChild(tempDiv);
      
      // QR-Code im temporären Container generieren (Größe 400×400)
      var qrSize = 400;
      new QRCode(tempDiv, {
        text: url,
        width: qrSize,
        height: qrSize,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
      });
      
      // Leicht verzögern, damit der QR-Code erzeugt wird
      setTimeout(function() {
        var qrCanvas = tempDiv.querySelector("canvas");
        if (!qrCanvas) {
          alert("QR-Code konnte nicht generiert werden.");
          document.body.removeChild(tempDiv);
          return;
        }
        
        // DIN-A4 Canvas (hier ca. 792×1123 Pixel bei 96 DPI)
        var a4Canvas = document.getElementById("a4Canvas");
        var ctx = a4Canvas.getContext("2d");
        ctx.clearRect(0, 0, a4Canvas.width, a4Canvas.height);
        
        // Weißer Hintergrund
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, a4Canvas.width, a4Canvas.height);
        
        // Titel (QR-Code Name) oben zentriert
        ctx.fillStyle = "#000000";
        ctx.font = "30px sans-serif";
        ctx.textAlign = "center";
        ctx.fillText(name, a4Canvas.width / 2, 50);
        
        // QR-Code zentriert unterhalb des Titels
        var xPos = (a4Canvas.width - qrSize) / 2;
        var yPos = 100;
        ctx.drawImage(qrCanvas, 0, 0, qrCanvas.width, qrCanvas.height, xPos, yPos, qrSize, qrSize);
        
        // DIN-A4 Canvas in ein PNG umwandeln
        var dataURL = a4Canvas.toDataURL("image/png");
        
        // Download auslösen
        var link = document.createElement("a");
        link.href = dataURL;
        // Dateiname bereinigen (z. B. Sonderzeichen entfernen)
        var filename = name.replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'qr_code';
        link.download = filename + ".png";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Temporären Container entfernen
        document.body.removeChild(tempDiv);
      }, 100);
    }
  </script>
  
  <!-- Bootstrap 5 JS Bundle (enthält Popper u.a.) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
